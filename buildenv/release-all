#!/usr/bin/env bash

set -o errexit
set -o nounset
set -o pipefail

cd `dirname "$BASH_SOURCE"`/..

function defer {
	if [[ $REGISTRY == gcr.io/* ]]; then
		docker logout gcr.io
		export DONT_LOGIN="false"
	fi
}

trap defer EXIT

# We source this a bunch of times just to make stuff work. TODO: this needs a clean up
REGISTRY="${REGISTRY:-gcr.io/cassandra-operator}"


if [[ $REGISTRY == gcr.io/* ]]; then
	gcloud docker -a
fi

export DONT_LOGIN="true"

docker push "${REGISTRY}/base-openjre:latest"
docker push "${REGISTRY}/cassandra-operator:latest"
docker push "${REGISTRY}/cassandra-sidecar:latest"
docker push "${REGISTRY}/cassandra:latest"
docker push "${REGISTRY}/cassandra:3.11.3"
